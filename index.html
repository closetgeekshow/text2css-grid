<link href="styles.css" rel="stylesheet" type="text/css">

<div class="grid"></div> <!-- grid container -->

<script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
<script>
$(function() {
var layout =`
+------------------------------------------------+
|                                                |
|                                                |
+-----+------------------+-----------------+-----+
|     |                  |                 |     |
|     |                  |                 |     |
|     |                  |                 |     |
|     |                  |                 |     |
|     |                  |                 |     |
|     |                  |                 |     |
|     |                  |                 |     |
|     |                  |                 |     |
|     |                  |                 |     |
|     |                  |                 |     |
|     |                  |                 |     |
+-----+------------------+-----------------+-----+
|                                                |
|                                                |
+------------------------------------------------+
`;

function splitLines(layout) {
            return layout.split(/[\r\n]/);
}

function processLine(line) {
            if (line.match(/\+/)) {
                return processLineWithPlus(line);
            } else {
                return processLineWithoutPlus(line);
            }
}

function processLineWithPlus(line) {
            return line.split(/[\+\|]/)
                       .filter(e => e)
                       .map(processBox);
}

function processLineWithoutPlus(line) {
            return line.split(/\|/)
                       .filter(e => e)
                       .map(b => b.length + 1);
}

function processBox(b) {
            if (b.match(/^\-+$/)) {
                return -(b.length + 1);
            } else {
                return b.length + 1;
            }
}

function filterEmptyArrays(arr) {
            return arr.filter(e => e.length);
}

// Main function
function processLayout(layout) {
            return filterEmptyArrays(
                splitLines(layout).map(processLine)
            );
}

// Usage
var lines = processLayout(layout);
var bgcolors = ["#f7a7a7", "#d0f7a7", "#f7d6a7", "#a7e2f7", "#e7bafb", "#fbbadc", "#def5d1", "#f7f1a7", "#b5fdd6", "#fb9387"]; //put some nice background colors here for our boxes
var crow = 0;      // current row. not the bird :)
var boxes = [];    // the array that contains all box definitions

lines.filter(e => e) // filter out zero length lines
.forEach(function(e) {
function getStartColumns(e) {
  return e.map((x, i, a) => a.filter((y, j) => j < i).reduce((s, z) => s + Math.abs(z), 1));
}

function findOpenBoxesAtColumn(col) {
  return boxes.filter(b => b.col === col && b.opn);
}

function addRowToOpenBoxes(openBoxes) {
  openBoxes.forEach(b => b.hgt++);
}

function createNewBox(row, col, width, color) {
  return {
      row: row,
      col: col,
      wid: width,
      hgt: 1,
      clr: color,
      opn: true
  };
}

function closeOpenBoxes(openBoxes) {
  openBoxes.forEach(b => {
      b.hgt++;
      b.opn = false;
  });
}

function processLine(e, crow) {
  let o = getStartColumns(e);
  e.forEach((x, i) => {
      let openBoxes = findOpenBoxesAtColumn(o[i]);
      if (x > 0) {
          if (openBoxes.length) {
              addRowToOpenBoxes(openBoxes);
          } else {
              let newBox = createNewBox(crow, o[i], x, bgcolors[boxes.length % bgcolors.length]);
              boxes.push(newBox);
          }
      } else {
          closeOpenBoxes(openBoxes);
      }
  });
  return crow + 1;
}

// Main processing
crow = processLine(e, crow);
});

function calculateGridDimensions(lines) {
      const nrows = lines.length - 1;
      const ncols = lines[0].reduce((s, e) => s + Math.abs(e), 0);
      return { nrows, ncols };
}

function setGridCSSVariables(nrows, ncols) {
      const rows = `repeat(${nrows}, 1fr)`;
      const cols = `repeat(${ncols}, 1fr)`;
      document.documentElement.style.setProperty('--grid-rows', rows);
      document.documentElement.style.setProperty('--grid-cols', cols);
      document.documentElement.style.setProperty('--nrows', nrows);
}

function createBoxElement(box, index) {
      return $(`<div>${index + 1}</div>`)
          .attr('style', `--row: ${box.row}; --col: ${box.col}; --wid: ${box.wid}; --hgt: ${box.hgt}; --bg-color: ${box.clr};`);
}

function appendBoxesToGrid(boxes) {
      boxes.forEach((box, index) => {
          createBoxElement(box, index).appendTo('.grid');
      });
}

// Main processing
const { nrows, ncols } = calculateGridDimensions(lines);
setGridCSSVariables(nrows, ncols);
appendBoxesToGrid(boxes);
});
</script>
